# 企鹅工坊 - 后端连接问题修复指南

## 📋 问题总结

你的应用在打包后运行时显示"后端未连接",主要原因是:

### ❌ **致命错误**
**electron-builder.yml 配置错误**,将后端可执行文件 `penguin-backend.exe` 排除在打包之外:

```yaml
# ❌ 错误配置 (已修复)
- "!backend-nodejs/penguin-backend.exe"
```

导致 EXE 安装包中没有后端程序,前端无法连接后端 API。

---

## ✅ 已完成的修复

### 1. 修复了 electron-builder.yml
删除了排除 `penguin-backend.exe` 的配置,现在后端 exe 会被正确打包。

### 2. 创建了辅助工具
- **诊断后端问题.bat** - 快速诊断问题
- **修复后端连接-完整构建.bat** - 一键修复并重新构建

---

## 🚀 立即修复 (三步走)

### 方案 A: 快速修复 (推荐)

1. **运行诊断工具**
   ```batch
   双击: 诊断后端问题.bat
   ```
   这会告诉你具体哪里有问题

2. **运行完整构建**
   ```batch
   双击: 修复后端连接-完整构建.bat
   ```
   这会自动:
   - 清理旧文件
   - 重新构建后端 EXE
   - 重新构建前端
   - 重新打包应用

3. **测试新安装包**
   - 安装 `release\企鹅工坊-Setup.exe`
   - 启动应用,检查后端连接

---

### 方案 B: 手动修复 (如果想了解细节)

#### 步骤 1: 构建后端 EXE
```batch
cd backend-nodejs
npm run build
```

检查是否生成 `backend-nodejs\penguin-backend.exe`

#### 步骤 2: 构建前端
```batch
# 回到项目根目录
cd ..
npm run build:frontend
```

检查是否生成 `dist\index.html`

#### 步骤 3: 打包应用
```batch
npm run build
```

或
```batch
npx electron-builder --win
```

#### 步骤 4: 测试
- 安装 `release\企鹅工坊-Setup.exe`
- 启动应用

---

## 🔍 验证修复

### 1. 检查打包内容
解压安装包或安装后,检查以下文件是否存在:

```
安装目录\
├── resources\
│   └── backend-nodejs\
│       └── penguin-backend.exe  ← 必须存在!
├── locales\
└── 企鹅工坊.exe
```

### 2. 检查运行状态
启动应用后:

**方法 1: 任务管理器**
- 打开任务管理器
- 查找 `penguin-backend.exe` 进程
- 如果存在 = 后端启动成功 ✅

**方法 2: 网络连接**
```batch
netstat -ano | findstr :8766
```
如果看到监听端口 = 后端启动成功 ✅

**方法 3: 浏览器测试**
打开浏览器访问: `http://localhost:8766/api/status`
应该返回 JSON 数据

---

## 🐛 如果仍然失败

### 问题 1: 端口被占用
**症状**: 应用启动但后端未连接

**解决**:
```batch
# 查找占用 8766 端口的进程
netstat -ano | findstr :8766

# 终止进程 (替换 PID)
taskkill /F /PID <进程ID>
```

### 问题 2: 防火墙阻止
**症状**: 后端启动但无法连接

**解决**:
- Windows 设置 → 隐私和安全性 → Windows 安全中心 → 防火墙
- 允许 `企鹅工坊.exe` 和 `penguin-backend.exe` 通过防火墙

### 问题 3: 后端启动失败
**症状**: 进程管理器中没有 penguin-backend.exe

**解决**:
1. 以管理员身份运行应用
2. 检查 Windows 事件查看器中的应用程序日志
3. 手动运行后端查看错误:
   ```batch
   cd %APPDATA%\penguin-magic\backend-nodejs
   penguin-backend.exe
   ```

### 问题 4: 缺少运行时
**症状**: 点击应用无反应

**解决**:
安装 [Visual C++ Redistributable](https://aka.ms/vs/17/release/vc_redist.x64.exe)

---

## 📊 技术细节

### 端口配置
- **后端端口**: 8766 (backend-nodejs/src/config.js)
- **前端开发端口**: 5176 (vite.config.ts)
- **Electron 检查端口**: 8766 (electron/main.ts)

### 目录结构
```
Penguin-Magic-main/
├── backend-nodejs/
│   ├── src/server.js           # 后端入口
│   ├── src/config.js           # 配置 (端口 8766)
│   ├── package.json            # 后端依赖
│   └── penguin-backend.exe     # 编译后的后端 (pkg 打包)
├── electron/
│   └── main.ts                 # Electron 主进程
│                               # 生产环境启动 penguin-backend.exe
├── dist/                       # 前端构建产物
└── release/                    # 最终安装包
```

### 后端启动流程
1. Electron 启动 (`electron/main.ts`)
2. 检查端口 8766 是否被占用
3. 启动 `penguin-backend.exe`
4. 等待 2 秒让后端初始化
5. 加载前端界面
6. 前端连接 `http://localhost:8766`

---

## 📝 检查清单

运行完整构建前,确保:

- [ ] Node.js 版本 >= 18
- [ ] 已删除 `electron-builder.yml` 中的排除规则
- [ ] `backend-nodejs/package.json` 配置正确
- [ ] 前端和后端依赖都已安装 (`npm install`)
- [ ] 没有其他程序占用 8766 端口

---

## 🎯 下一步

1. **立即运行**: `修复后端连接-完整构建.bat`
2. **测试新安装包**: 安装并启动应用
3. **验证后端连接**: 在应用中测试功能
4. **如有问题**: 运行 `诊断后端问题.bat` 查看详情

---

## 💡 预防措施

为了避免将来出现同样问题:

1. **不要排除关键文件**
   - electron-builder.yml 中不要排除 `penguin-backend.exe`
   - 只排除 `node_modules`

2. **测试打包结果**
   - 每次打包后检查 `resources/backend-nodejs/` 目录
   - 确保 `penguin-backend.exe` 存在

3. **使用构建脚本**
   - 使用 `修复后端连接-完整构建.bat` 确保完整构建
   - 避免手动构建遗漏步骤

---

## 📞 仍需帮助?

如果以上方案都无效,请提供:

1. `诊断后端问题.bat` 的完整输出
2. Windows 事件查看器中的应用程序错误日志
3. 任务管理器截图 (运行应用时)
4. 浏览器控制台错误 (按 F12)

---

**最后更新**: 2025-12-29
**版本**: v0.3.0
**状态**: ✅ 配置已修复
